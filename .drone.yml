---
kind: pipeline
type: kubernetes
name: Staging

platform:
  arch: amd64
  os: linux

volumes:
  - name: cache
    temp: {}

steps:
  - name: Build
    image: golang:1.13.0
    commands:
      - go test
      - go build -o main
    volumes:
      - name: artifacts
        path: /go
    environment:
      GOARCH: amd64
      GOOS: linux


  - name: release
    image: plugins/docker
    settings:
      tags: latest
      auto_tag: false
      repo: lehtux/argocd
      username:
        from_secret: username
      password:
        from_secret: password
    volumes:
      - name: artifacts
        path: /go

  - name: Manifest
    image: lehtux/kust
    commands:
      - mkdir -p ~/.ssh
      - chmod 700 ~/.ssh
      - echo "Host *\n\tStrictHostKeyChecking no" > ~/.ssh/config
      - echo $SSH_PRIVATE_KEY_STAGING > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - cat ~/.ssh/id_rsa
      - git clone git@github.com:jlehtimaki/argo_manifests.git
      - cd argo_manifests/kustomize
      - kustomize edit set image lehtux/argocd:1.0
      - git commit -am "Updated image"
      - git push
    environment:
      SSH_PRIVATE_KEY_STAGING:
        from_secret: ssh_secret
